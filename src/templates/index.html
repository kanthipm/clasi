{% extends "base.html" %}
{% block title %}CLASI - Course Listings{% endblock %}
{% block content %}
<style>
  form.search-form {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-start;
    margin-bottom: 1.5rem;
  }
  .form-group {
    flex: 1 0 200px;
    position: relative;
    margin-bottom: 1rem;
  }
  label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: bold;
  }
  select, input[type="text"] {
    width: 100%;
    padding: 0.5rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .checkbox-group label {
    display: inline-block;
    font-weight: normal;
    margin-right: 0.5rem;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 1rem;
  }
  table, th, td {
    border: 1px solid #ccc;
  }
  th, td {
    padding: 0.5rem;
    text-align: left;
  }
  .course-row {
    cursor: pointer;
  }
  .detail-row {
    background-color: #f9f9f9;
  }
  .favorite-btn {
    cursor: pointer;
    font-size: 1.2rem;
    background: none;
    border: none;
    margin-right: 5px;
  }
  .suggestions {
    border: 1px solid #ccc;
    background-color: #fff;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
    max-height: 150px;
    overflow-y: auto;
  }
  .suggestion-item {
    padding: 0.5rem;
    cursor: pointer;
  }
  .suggestion-item:hover {
    background-color: #f0f0f0;
  }
  .review {
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #ddd;
  }
</style>

<div class="container">
  <form id="courseForm" class="search-form">
    <div class="form-group">
      <label for="subject-select">Select Subject:</label>
      <select id="subject-select" name="subject">
        <option value="">-- All Subjects --</option>
        {% for subj in subjects %}
          <option value="{{ subj }}">{{ subj }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label>Area(s) of Knowledge:</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="aok" value="ALP"> ALP</label>
        <label><input type="checkbox" name="aok" value="CZ"> CZ</label>
        <label><input type="checkbox" name="aok" value="NS"> NS</label>
        <label><input type="checkbox" name="aok" value="QS"> QS</label>
        <label><input type="checkbox" name="aok" value="SS"> SS</label>
      </div>
    </div>
    <div class="form-group">
      <label>Mode(s) of Inquiry:</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="moi" value="CCI"> CCI</label>
        <label><input type="checkbox" name="moi" value="EI"> EI</label>
        <label><input type="checkbox" name="moi" value="STS"> STS</label>
        <label><input type="checkbox" name="moi" value="FL"> FL</label>
        <label><input type="checkbox" name="moi" value="R"> R</label>
        <label><input type="checkbox" name="moi" value="W"> W</label>
      </div>
    </div>
    <div class="form-group">
      <label for="professor">Professor Search:</label>
      <input type="text" id="professor" name="professor" autocomplete="off" placeholder="Enter professor name">
      <div id="professor-suggestions" class="suggestions"></div>
    </div>
    <div class="form-group" style="align-self:flex-end;">
      <button type="submit">Fetch Courses</button>
    </div>
  </form>
  <div id="results"></div>
</div>

<script>
  let favoritesList = [];
  function toggleFavorite(e, id) {
    e.stopPropagation();
    // existing favorite toggle logic
  }
  async function fetchFavorites() {
    const res = await fetch('/api/favorites');
    favoritesList = (await res.json()).map(c => c.id);
  }
  async function fetchCourses() {
    const form = document.getElementById('courseForm');
    const params = new URLSearchParams(new FormData(form));
    const data = await (await fetch(`/api/courses?${params}`)).json();
    renderCourses(data);
  }
  function renderCourses(courses) {
    const results = document.getElementById('results');
    if (!courses.length) { results.innerHTML = '<p>No courses found.</p>'; return; }
    let html = '<table class="table"><thead><tr>' +
      '<th></th><th>ID</th><th>Dept</th><th>Cat #</th><th>Title</th><th>AOK</th><th>MOI</th><th>Professors</th>' +
      '</tr></thead><tbody>';
    courses.forEach(c => {
      const heart = favoritesList.includes(c.id) ? '‚ù§Ô∏è' : 'ü§ç';
      html += `<tr class="course-row" data-id="${c.id}">` +
        `<td><button class="favorite-btn">${heart}</button></td>` +
        `<td>${c.id}</td><td>${c.subject}</td><td>${c.catalog_nbr || ''}</td>` +
        `<td>${c.title}</td><td>${c.aok||''}</td><td>${c.moi||''}</td><td>${c.professors||''}</td>` +
      `</tr>`;
    });
    html += '</tbody></table>';
    results.innerHTML = html;
    document.querySelectorAll('.favorite-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const id = e.target.closest('tr').dataset.id;
        toggleFavorite(e, id);
      });
    });
  }
  document.getElementById('courseForm').addEventListener('submit', e => {
    e.preventDefault(); fetchFavorites().then(fetchCourses);
  });
  document.addEventListener('DOMContentLoaded', () => {
    fetchFavorites().then(fetchCourses);
    document.getElementById('professor').addEventListener('input', async ({target}) => {
      const q = target.value; if (q.length < 2) return;
      const list = await (await fetch(`/api/professors?query=${encodeURIComponent(q)}`)).json();
      const sug = document.getElementById('professor-suggestions'); sug.innerHTML = '';
      list.forEach(n => { const d = document.createElement('div'); d.className='suggestion-item'; d.textContent = n;
        d.onclick = () => { target.value = n; sug.innerHTML='';}; sug.appendChild(d);
      });
    });
  });
</script>
{% endblock %}