{% extends "base.html" %}
{% block title %}CLASI - Course Listings{% endblock %}
{% block content %}
<style>
  form {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-start;
    margin-bottom: 1.5rem;
  }
  .form-group {
    flex: 1 0 200px;
  }
  label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: bold;
  }
  select, input[type="text"] {
    width: 100%;
    padding: 0.5rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .checkbox-group label {
    display: inline-block;
    font-weight: normal;
    margin-right: 0.5rem;
  }
  button {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background-color: #0056b3;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 1rem;
  }
  table, th, td {
    border: 1px solid #ccc;
  }
  th, td {
    padding: 0.5rem;
    text-align: left;
  }
</style>

<div class="container">
  <form id="courseForm">
    <!-- Department Dropdown -->
    <div class="form-group">
      <label for="department">Select Subject:</label>
      <select id="department" name="department">
        <option value="">-- Choose a Subject --</option>
        {% for subj in subjects %}
          <option value="{{ subj }}">{{ subj }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Areas of Knowledge Checkboxes -->
    <div class="form-group">
      <label>Area(s) of Knowledge:</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="aok" value="ALP"> ALP</label>
        <label><input type="checkbox" name="aok" value="CZ"> CZ</label>
        <label><input type="checkbox" name="aok" value="NS"> NS</label>
        <label><input type="checkbox" name="aok" value="QS"> QS</label>
        <label><input type="checkbox" name="aok" value="SS"> SS</label>
      </div>
    </div>

    <!-- Modes of Inquiry Checkboxes -->
    <div class="form-group">
      <label>Mode(s) of Inquiry:</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="moi" value="CCI"> CCI</label>
        <label><input type="checkbox" name="moi" value="EI"> EI</label>
        <label><input type="checkbox" name="moi" value="STS"> STS</label>
        <label><input type="checkbox" name="moi" value="FL"> FL</label>
        <label><input type="checkbox" name="moi" value="R"> R</label>
        <label><input type="checkbox" name="moi" value="W"> W</label>
      </div>
    </div>

    <!-- Professor Search -->
    <div class="form-group">
      <label for="professor">Professor Search:</label>
      <input type="text" id="professor" name="professor" placeholder="Enter professor name">
    </div>

    <div class="form-group" style="align-self: flex-end;">
      <button type="submit">Fetch Courses</button>
    </div>
  </form>
  <div id="results"></div>
</div>

<script>
  document.getElementById('courseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    var department = document.getElementById('department').value;
    var professor = document.getElementById('professor').value;
    
    // Collect checked AOK values
    var aokCheckboxes = document.querySelectorAll('input[name="aok"]:checked');
    var aokValues = Array.from(aokCheckboxes).map(cb => cb.value);
    
    // Collect checked MOI values
    var moiCheckboxes = document.querySelectorAll('input[name="moi"]:checked');
    var moiValues = Array.from(moiCheckboxes).map(cb => cb.value);
    
    var params = new URLSearchParams();
    if(department) params.append("department", department);
    if(professor) params.append("professor", professor);
    aokValues.forEach(val => params.append("aok", val));
    moiValues.forEach(val => params.append("moi", val));
    
    fetch(`/courses?${params.toString()}`)
      .then(response => response.json())
      .then(data => {
        var resultsDiv = document.getElementById('results');
        if(data.error){
          resultsDiv.innerHTML = `<p>Error: ${data.error}</p>`;
        } else {
          var html = "<table><tr><th>ID</th><th>Department</th><th>Catalog #</th><th>Title</th><th>Topic</th><th>AOK</th><th>MOI</th><th>Professor(s)</th></tr>";
          data.forEach(course => {
            html += `<tr>
              <td>${course.id}</td>
              <td>${course.department}</td>
              <td>${course.catalog_nbr}</td>
              <td>${course.title}</td>
              <td>${course.topic_id}</td>
              <td>${course.aok}</td>
              <td>${course.moi}</td>
              <td>${course.professors || ""}</td>
            </tr>`;
          });
          html += "</table>";
          resultsDiv.innerHTML = html;
        }
      })
      .catch(err => {
        console.error(err);
        alert("Error fetching courses.");
      });
  });
</script>
{% endblock %}
